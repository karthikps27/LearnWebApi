AWSTemplateFormatVersion: 2010-09-09
Description: "PostgresDB Stack for fargate instance of LearnWebApi"
Outputs:
  ApplicationSecurityGroup:
    Value: !GetAtt Endpoint.Address
Parameters: 
  VpcId:
    Type: AWS::EC2::VPC::Id
  ApplicationSecurityGroupId:
    Type: String
  DBName:
    Type: String
  DBInstanceClass:
    Type: String
  DBUsername:
    Type: String
  DBPassword:
    Type: String
Resources:
  DatabaseSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: "Security group for database"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 5432
        ToPort: 5432
        SourceSecurityGroupId: !Ref ApplicationSecurityGroupId
  DBInstance:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      AllocatedStorage: 20
      AllowMajorVersionUpgrade: false
      AutoMinorVersionUpgrade: true
      DBInstanceClass: "db.t2.micro"
      DBName: !Ref DBName
      DBParameterGroupName: "default.postgres11"
      Engine: postgres
      EngineVersion: "11.6"
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup